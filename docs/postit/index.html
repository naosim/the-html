<!DOCTYPE html>
<!-- <link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=M+PLUS+Rounded+1c&display=swap" rel="stylesheet"> -->

<style>
  @import url('https://fonts.googleapis.com/css2?family=M+PLUS+1+Code&display=swap');
  body {
    margin: 0px;
  }
  .postit {
    background: #ffa;
    position: absolute;
    padding: 8px;
    white-space: pre-wrap;
    font-size: 16px;
    /* font-family: monospace; */
    font-family: 'M PLUS 1 Code', sans-serif;
    cursor:grab;
    opacity: 0.1;
    line-height: 20px;
  }
  .invisibleText {
    color: rgba(0, 0, 0, 0);
  }
  .selected {
    box-shadow: 0px 0px 6px #000;
  }
  .editingLink {
    position: absolute;
    cursor: nw-resize;
  }
  .st0{fill:#7AC385;stroke:#356837;}

  .textarea {
    position: absolute;
    font-size: 16px;
    /* opacity: 0.8; */
    margin: 0px;
    margin-top: 6px;
    margin-left: 6px;
    padding: 2px;
    /* padding: 8px; */
    line-height: 20px;
    overflow:hidden;
    background-color: rgba(0, 0, 0, 0);
    /* background-color: #faf; */
    border-style: none;
    outline:0;
    font-family: 'M PLUS 1 Code', sans-serif;
    /* opacity: 0.5; */
    /* color: red; */
  }
  .invisible {
    opacity: 0;
  }
  svg {
    position: absolute;
  }
  .right-toolbar {
    position: fixed;
    width: 64px;
    background-color: aliceblue;
    right: 0px;
  }
</style>

<script src="https://cdn.jsdelivr.net/npm/vue@2/dist/vue.js"></script>
<div id="app">
  <!-- 編集中の線描画 -->
  <svg version="1.1" xmlns="http://www.w3.org/2000/svg" width="100%" height="1000">
    <line class="editingLinkLine" v-show="editingLink.isEditing" v-bind:x1="editingLink.startPostit.center.x" v-bind:y1="editingLink.startPostit.center.y" v-bind:x2="lineEndPos.x" v-bind:y2="lineEndPos.y" stroke="black" />
  </svg>

  <!-- 最終成果物のsvg -->
  <svg id="mainSvg" version="1.1" xmlns="http://www.w3.org/2000/svg" width="100%" height="1000">
    <!-- <defs>
      <style>
        <![CDATA[@import url('https://fonts.googleapis.com/css2?family=RocknRoll+One&display=swap');]]>
      </style>
    </defs> -->
    <!-- 矢印 -->
    <marker id="m_ar" viewBox="0 0 10 10" refX="5" refY="5" markerUnits="strokeWidth" preserveAspectRatio="none" markerWidth="8" markerHeight="6" orient="auto-start-reverse">
      <polygon points="2,2 2,8 6,5" fill="#555" />
    </marker>
    <marker id="m_ar_selected" viewBox="0 0 10 10" refX="5" refY="5" markerUnits="strokeWidth" preserveAspectRatio="none" markerWidth="8" markerHeight="6" orient="auto-start-reverse">
      <polygon points="2,2 2,8 6,5" fill="#e41" />
    </marker>

    <g v-for="postit in postits.values" >
      <rect 
        v-bind:id="'rect' + postit.id"
        v-bind:x="postit.pos.x"
        v-bind:y="postit.pos.y"
        v-bind:width="postit.isDiv ? postit.size.width : postit.size.width"
        v-bind:height="postit.size.height"
        fill="#ffa"
        stroke="#888"
        v-bind:stroke-width="selectedPostits.values.length > 0 && selectedPostits.isSelected(postit) ? 4 : 1"
      />
      <text
        stroke="none" 
        v-for="(text, index) in postit.text.split('\n')" 
        v-bind:x="postit.pos.x + 8"
        v-bind:y="postit.pos.y + index * textHeight + 23"
        font-size="16"
        style="font-family: 'M PLUS 1 Code', sans-serif;white-space:pre;"
        v-show="editingPostit.id != postit.id || !isFocusForText"
        v-text="text"
      ></text>
    </g>

    <path 
      v-for="link in links.values" 
      v-bind:d="getLinePath(link)" 
      v-on:click="clickLine($event, link)"
      fill="none" 
      v-bind:stroke="selectedLinks.isSelected(link) ? '#e41' : '#555'" 
      stroke-width="4" 
      v-bind:marker-end="selectedLinks.isSelected(link) ? 'url(#m_ar_selected)' : 'url(#m_ar)'" marker-end-fill="red"
    />
  </svg>
  
  <!-- 付箋サイズ計算用 -->
  <div
    v-for="postit in postits.values" 
    ref="postit" 
    v-bind:id="postit.id"
    v-bind:style="{ left: postit.pos.x + 'px', top: postit.pos.y + 'px' }" 
    v-bind:class="['postit']"

    @mousedown="dragMouseDown($event, postit)" 
    v-text="toDisplayText(postit.text)"
  ></div>

  <div class="editingLink" v-bind:style="{ left: editingLink.pos.x - 8 + 'px', top: editingLink.pos.y - 8 + 'px' }" @mousedown="dragMouseDownForLink">●</div>
  <textarea 
    ref="textarea"
    v-bind:class="['textarea', isFocusForText ? '': 'invisible']"
    v-model="editingPostit.text" 
    v-on:focus="isFocusForText = true" v-on:blur="isFocusForText = false"
    v-bind:style="{left: editingPostit.pos.x + 'px', top: editingPostit.pos.y + 'px', width: (editingPostit.text.length > 0 ? editingPostit.size.width : editingPostit.size.width) - 6 + 'px', height: (editingPostit.text.length > 0 ? editingPostit.size.height : editingPostit.size.height) + 'px' }"
  ></textarea>

  <div class="right-toolbar">
    <button v-on:click="createNoLinkPostit">付箋追加</button><br>
    <button v-on:click="deletePostit">付箋削除</button><br>
    <button v-on:click="outputText">テキスト出力</button><br>
    <button v-on:click="outputSvg">SVG出力</button><br>
    <button v-on:click="createNewSheet">新規作成</button><br>
  </div>
</div>

<script type="module" src="./js/dist/main.js"></script>