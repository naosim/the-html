<!DOCTYPE html>
<style>
  .postit {
    background: #ffa;
    position: absolute;
    padding: 6px;
    white-space: pre-wrap;
  }
  .selected {
    box-shadow: 0px 0px 6px #000;
  }
</style>

<script src="https://cdn.jsdelivr.net/npm/vue@2/dist/vue.js"></script>


<h1>postit</h1>

<div id="app">
  <div v-for="postit in postits" v-bind:class="['postit', postit.selected ? 'selected' : '']" v-bind:style="{ left: postit.pos.x + 'px', top: postit.pos.y + 'px' }"  @mousedown="dragMouseDown($event, postit)" v-text="postit.text"></div>
  <textarea v-model="editingPostit.text"></textarea>
</div>

<!-- <svg version="1.1" xmlns="http://www.w3.org/2000/svg" width="50" height="50" viewBox="0 0 200 200">
  <style type="text/css">
    .st0{fill:#7AC385;stroke:#356837;}
  </style>
  <circle class="st0" cx="100" cy="100" r="100"/>
</svg> -->

<script>
const data = {
  message: 'Hello Vue!',
  dragPositions: {
    clientX: undefined,
    clientY: undefined,
    movementX: 0,
    movementY: 0
  },
  postits: [
    {
      id: "001",
      text: "hoge",
      pos: {x: 0, y: 100}
    },
    {
      id: "002",
      text: "foo",
      pos: {x: 100, y: 0},
      selected: false
    }
  ],
  editingPostit: {
    id: undefined,
    text: ""
  }
};

// function findPostit(id) {
//   const list = data.postits.filter(v => v.id == data.editingPostit.id);
//   return list.length == 1 ? list[0] : undefined;
// }

var app = new Vue({
  el: '#app',
  data: data,
  methods: {
    dragMouseDown: function (event, postit) {
      if(this.editingPostit.id != postit.id) {
        this.editingPostit.selected = false;// 前回の選択を外す
      }
      postit.selected = true;
      this.editingPostit = postit;
      

      event.preventDefault()
      // get the mouse cursor position at startup:
      this.dragPositions.clientX = event.clientX
      this.dragPositions.clientY = event.clientY
      document.onmousemove = (event) => this.elementDrag(event, postit);
      document.onmouseup = (event) => this.closeDragElement(event, postit);
    },
    elementDrag: function (event, postit) {
      event.preventDefault()
      this.dragPositions.movementX = this.dragPositions.clientX - event.clientX
      this.dragPositions.movementY = this.dragPositions.clientY - event.clientY
      this.dragPositions.clientX = event.clientX
      this.dragPositions.clientY = event.clientY
      // set the element's new position:
      postit.pos.x = (postit.pos.x - this.dragPositions.movementX);
      postit.pos.y = (postit.pos.y - this.dragPositions.movementY);
    },
    closeDragElement () {
      document.onmouseup = null
      document.onmousemove = null
    }
  }
})
</script>